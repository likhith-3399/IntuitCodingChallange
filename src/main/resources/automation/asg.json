{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Voting Service ASG",

  "Parameters": {
    "ProxyRequired": {
      "Description": "Determines if proxies need to be set in userdata",
      "Type": "String",
      "Default": "false"
    },
    "EBSDeviceName": {
      "Description": "The name of the EBS device within Amazon EC2",
      "Type": "String"
    },
    "EBSVolumeSize": {
      "Description": "EBS Volumes size in gigabytes",
      "Type": "String"
    },
    "EBSVolumeType": {
      "Description": "EBS Volume type",
      "Type": "String"
    },
    "EBSDeleteOnTermination": {
      "Description": "Determines whether to delete the volume on instance termination",
      "Type": "String"
    },
    "EBSEncrypted": {
      "Description": "Determines if the EBS should be encypted",
      "Type": "String"
    },
    "ImageId": {
      "Description": "Provides the unique ID of the Amazon Machine Image (AMI)",
      "Type": "AWS::EC2::Image::Id",
      "Default": "ami-c998b6b2"
    },
    "InstanceType": {
      "Description": "The type of the ec2 instance you are creating",
      "Type": "String",
      "Default": "t2.micro"
    },
    "SecurityGroupIds": {
      "Description": "A list that contains the security group IDs for VPC security groups to assign to the EC2 Instance",
      "Type": "CommaDelimitedList"
    },
    "Timezone": {
      "Description": "Timezone",
      "Type": "String",
      "AllowedValues": [
        "New_York",
        "Chicago",
        "Denver",
        "Los_Angeles"
      ]
    },
    "Name": {
      "Description": "Name of the ec2 Instance",
      "Type": "String",
      "Default": "Voting Service node"
    },
    "ApplicationName": {
      "Description": "Name of application the instance is a part of",
      "Type": "String",
      "Default": "Voting Service"
    },
    "OwnerContact": {
      "Type": "String"
    },
    "MinSize": {
      "Description": "Minimum number of nodes to having running at any given time",
      "Type": "String"
    },
    "MaxSize": {
      "Description": "Maximum number of nodes to having running at any given time",
      "Type": "String"
    },
    "Subnets": {
      "Description": "Subnets to launch nodes nodes into",
      "Type": "CommaDelimitedList"
    },
    "SubnetId": {
      "Description": "ID of the subnet you want to launch the instance into",
      "Type": "AWS::EC2::Subnet::Id",
      "Default": "subnet-d5b8c0b1"
    },
    "LoadBalancerNames": {
      "Description": "ELB to connect the auto-scaling group to.",
      "Type": "CommaDelimitedList",
      "Default": ""
    },
    "IamInstanceProfile": {
      "Description": "Instance profile",
      "Type": "String",
      "Default": "Full_Access_Role_EC2_S3_Route53"
    },
    "Environment": {
      "Description": "Environment to which this instance belongs.",
      "Type": "String",
      "Default": "Dev"
    }
  },

  "Resources": {
    "LaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": {
          "Ref": "ImageId"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": { "Ref": "EBSDeviceName" },
            "Ebs": {
              "VolumeSize": { "Ref": "EBSVolumeSize" },
              "VolumeType": { "Ref": "EBSVolumeType" },
              "Encrypted": { "Ref": "EBSEncrypted" },
              "DeleteOnTermination": { "Ref": "EBSDeleteOnTermination" }
            }
          }
        ],
        "SecurityGroups": { "Ref": "SecurityGroupIds" },
        "IamInstanceProfile": { "Ref": "IamInstanceProfile" },
        "KeyName": "Acc_846095599110",
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -ex \n",
                "mkdir /etc/myVault \n",
                "touch nonce \n",
                "uuidgen > /etc/myVault/nonce \n"
              ]
            ]
          }
        }
      }
    },

    "ASG": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "LaunchConfigurationName": { "Ref": "LaunchConfig" },
        "MinSize": { "Ref": "MinSize" },
        "MaxSize": { "Ref": "MaxSize" },
        "VPCZoneIdentifier": { "Ref": "Subnets" },
        "LoadBalancerNames": { "Ref": "LoadBalancerNames"},
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "Name" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "ApplicationName",
            "Value": { "Ref": "ApplicationName" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "ASV",
            "Value": { "Ref": "ASV" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "CMDBEnvironment",
            "Value": { "Ref": "CMDBEnvironment" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "OwnerContact",
            "Value": { "Ref": "OwnerContact" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "ValueStream",
            "Value": { "Ref": "ValueStream" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" },
            "PropagateAtLaunch": "true"
          }
        ]
      }
    }
  }
}
